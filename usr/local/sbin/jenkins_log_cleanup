#!/bin/bash
#
# LOCAL_SBIN="/usr/local/sbin/jenkins_log_cleanup" && echo "" > "${LOCAL_SBIN}" && vi "${LOCAL_SBIN}" && chmod 0755 "${LOCAL_SBIN}";
#
# ------------------------------------------------------------
#
# Log all shell output & error output to logfile
#
LOGDIR="${HOME}/$(basename ${0})_logs"; if [ -w "/var/log/" ]; then LOGDIR="/var/log/$(basename ${0})"; fi;
mkdir -p "${LOGDIR}"; chown $(stat -c '%u:%g' $(dirname ${LOGDIR})) "${LOGDIR}"; chmod 0770 "${LOGDIR}";
LOGFILE="${LOGDIR}/$(basename ${LOGDIR})_$(date +'%Y%m%d_%H%M%S')"; echo "" > "${LOGFILE}"; chmod 0660 "${LOGFILE}";
exec > >(tee -a "${LOGFILE}" );
exec 2>&1;
#
# ------------------------------------------------------------
#
# Script must run as root or via sudo
#
if [ "$(id -un)" != "root" ]; then

	echo "$(date +'%Y-%m-%d %H:%M:%S') | Error: Script must run as user \"root\" or via \"sudo\" command";
	exit 1;

else

	SUDO_USER_HOMEDIR="$(getent passwd ${SUDO_USER} | cut --delimiter=: --fields=6)"; # Sudo-User's Home dir

	PS_AUX_CONTAINS="jenkins.war";

	DELETE_ITEMS_OLDER_THAN_DAYS=90;

	JENKINS_UNAME=$(ps aux | grep '/usr/bin/daemon' | grep "${PS_AUX_CONTAINS}" | awk {'print $1'});

	if [ -z "${JENKINS_UNAME}" ]; then # jenkins process not found
		echo "$(date +'%Y-%m-%d %H:%M:%S') | Error - No processes found which match text \"${PS_AUX_CONTAINS}\"";
		exit 1;
		
	elif [ -n "$(id -u ${JENKINS_UNAME} | grep 'no such user')" ]; then # jenkins user not found
		echo "$(date +'%Y-%m-%d %H:%M:%S') | Error - No users found with name \"${JENKINS_UNAME}\"";
		exit 1;

	else
		
		JENKINS_UHOME=$(getent passwd ${JENKINS_UNAME} | cut --delimiter=: --fields=6);

		if [ ! -d "${JENKINS_UHOME}" ]; then # jenkins home-dir not found
			echo "$(date +'%Y-%m-%d %H:%M:%S') | Error - Jenkins home-directory not found: \"${JENKINS_UHOME}\"";
			exit 1;

		else # good to go - begin deleting dirs

			find "${JENKINS_UHOME}/jobs/" \
				-maxdepth 3 \
				-type d \
				-regex "^${JENKINS_UHOME}/jobs/.+/builds/[0-9]+$" \
				-mtime +${DELETE_ITEMS_OLDER_THAN_DAYS} \
				-exec echo -ne "$(date +'%Y-%m-%d %H:%M:%S') $(id -un)@$(hostname) \n " \; \
				-exec rm -rfv -- '{}' \; \;
			;

		fi;

	fi;

	find "/var/log" \
		-mindepth 1 \
		-maxdepth 10 \
		-mtime +${DELETE_ITEMS_OLDER_THAN_DAYS} \
		-exec echo -ne "$(date +'%Y-%m-%d %H:%M:%S') $(id -un)@$(hostname) \n " \; \
		-exec rm -rfv -- '{}' \;;


	# # NGINX - Reload
	# echo -e "\n\n$(date +'%D  %r') Calling [ systemctl reload nginx; ]...";
	# systemctl reload nginx;

	# # Jenkins - Reload
	# RESTART_JENKINS_SERVICE="Yes";
	# if [ -n "${RESTART_JENKINS_SERVICE}" ]; then
	# 	if [ "${RESTART_JENKINS_SERVICE}" == "Yes" ]; then
	# 		DELAY_SECONDS=30;
	# 		(sleep ${DELAY_SECONDS}; service jenkins force-reload; ) & \
	# 		echo -e "\n\n$(date +'%D  %r') Creating parallel/background task: [ sleep ${DELAY_SECONDS}; service jenkins force-reload; ]...";
	# 	fi;
	# fi;

fi;
